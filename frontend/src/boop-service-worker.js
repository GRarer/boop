// custom service worker
console.log("boop custom service worker version 6");

// detect whether this instance is localhost or deployed
const host = `${self.registration.scope}`.includes("localhost")
  ? "http://localhost:8080/"
  : "https://boopboop.app/";

try {
  // import and extend the default service worker generated by Angular
  importScripts('./ngsw-worker.js');
  // listen for push notification clicks
  self.addEventListener('notificationclick', (event) => {
    const action = event.action;
    if (action === "show_start_chat") {
      // token lets us identify and authenticate permission for this notification even if the user is logged out
      const identityToken = event.notification.data.pushIdentityToken;
      // open app
      const queryParameter = new URLSearchParams({ token: identityToken });
      event.waitUntil(clients.openWindow(`${host}chat?${queryParameter.toString()}`));

      event.notification.close();
    } else if (action === "show_app") {
      console.log("navigating");
      event.notification.close();
      event.waitUntil(clients.openWindow(`${host}home`));
    } else if (action === "show_friends_page") {
      event.notification.close();
      event.waitUntil(clients.openWindow(`${host}add_friends`));
    }
  });
} catch (err) {
  if (
    err instanceof DOMException
    && err.name === "NetworkError"
    && err.message.includes(`Failed to execute 'importScripts' on 'WorkerGlobalScope'`)
  ) {
    console.warn(
      "Service worker not enabled. PWA features including push notifications will not be available.\n\n"
      + "This is expected behavior when using Angular's `ng serve` dev server.\n"
      + "For a local server that supports service workers, use `npm run start-pwa` instead."
    );
  } else {
    throw err;
  }
}
